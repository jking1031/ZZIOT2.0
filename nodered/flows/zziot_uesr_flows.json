[
    {
        "id": "514ec94e7d382f6a",
        "type": "tab",
        "label": "Áî®Êà∑ÁÆ°ÁêÜ",
        "disabled": false,
        "info": "Áî®‰∫éÂ§ÑÁêÜËÆ§ËØÅÁõ∏ÂÖ≥ÁöÑÊµÅÁ®ã",
        "env": []
    },
    {
        "id": "2b3e427d203d6fee",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÁôªÂΩïËØ∑Ê±Ç",
        "func": "// Ëé∑ÂèñÁî®Êà∑Âêç/ÈÇÆÁÆ±ÂíåÂØÜÁ†Å\nconst email = msg.payload.email;\nconst password = msg.payload.password;\n\n// È™åËØÅÂèÇÊï∞\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_PARAMS\",\n            message: \"ÈÇÆÁÆ±ÂíåÂØÜÁ†Å‰∏çËÉΩ‰∏∫Á©∫\"\n        }\n    };\n    return msg;\n}\n\n// ËÆæÁΩÆÊü•ËØ¢ÂèÇÊï∞ - ÊîØÊåÅ‰ΩøÁî®ÈÇÆÁÆ±ÊàñÁî®Êà∑ÂêçÁôªÂΩï\nmsg.topic = \"SELECT * FROM users1 WHERE email = ? \";\nmsg.payload = [email];\n\nreturn msg;",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 40,
        "wires": [
            [
                "129d352e7cd37318"
            ],
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "129d352e7cd37318",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Êü•ËØ¢Áî®Êà∑",
        "x": 560,
        "y": 40,
        "wires": [
            [
                "71212ac9a0d2aaa2"
            ]
        ]
    },
    {
        "id": "71212ac9a0d2aaa2",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "È™åËØÅÂØÜÁ†Å",
        "func": "const users = msg.payload;  // payload ÊòØÁî®Êà∑Êï∞ÁªÑ\nconst password = msg.req.body.password; // Ëé∑ÂèñÂâçÁ´ØÊèê‰∫§ÁöÑÂØÜÁ†Å\n\n// ÂÖ®Â±Ä‰æùËµñ\nconst bcrypt = global.get('bcrypt');\nconst jwt = global.get('jwt');\nconst uuid = global.get('uuid');\nconst jwtSecret = global.get('jwtSecret');\nconst jwtRefreshSecret = global.get('jwtRefreshSecret');\n\n// Áî®Êà∑‰∏çÂ≠òÂú®\nif (!users || users.length === 0) {\n    return [null, {\n            \"error\": {\n                \"code\": \"ERROR_CODE\",\n                \"message\": \"Áî®Êà∑‰∏çÂ≠òÂú®'\",\n                \"success\": false,   \n            }\n    }];\n}\n\nconst user = users[0];\n\n// ÂØÜÁ†Å‰∏çÂåπÈÖç\nconst passwordMatch = bcrypt.compareSync(password, user.password);\nif (!passwordMatch) {\n    return [null, {\n            \"error\": {\n                \"code\": \"ERROR_CODE\",\n                \"message\": \"Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ\",\n                \"success\": false,\n            }\n    }];\n}\n\n// ÁôªÂΩïÊàêÂäüÔºöÁîüÊàê JWT Âíå Refresh Token\nconst tokenId = uuid.v4();\nconst refreshTokenId = uuid.v4();\n\nconst tokenExpiry = new Date();\ntokenExpiry.setHours(tokenExpiry.getHours() + 24); // 24Â∞èÊó∂ÊúâÊïà\n\nconst tokenPayload = {\n    id: user.id,\n    username: user.username,\n    role: user.role || 'user',\n    company: user.company,\n    jti: tokenId\n};\n\nconst refreshPayload = {\n    id: user.id,\n    jti: refreshTokenId\n};\n\nconst token = jwt.sign(tokenPayload, jwtSecret, { expiresIn: '24h' });\nconst refreshToken = jwt.sign(refreshPayload, jwtRefreshSecret, { expiresIn: '7d' });\n\nmsg.tokenInfo = {\n    id: tokenId,\n    user_id: user.id,\n    token: token,\n    refresh_token: refreshToken,\n    expires_at: tokenExpiry\n};\n\nmsg.topic = \"INSERT INTO tokens (id, user_id, token, refresh_token, expires_at) VALUES (?, ?, ?, ?, ?)\";\nmsg.payload = [tokenId, user.id, token, refreshToken, tokenExpiry];\n\nmsg.userResponse = {\n    success: true,\n    data: {\n        token: token,\n        refreshToken: refreshToken,\n        message: 'ÁôªÂΩïÊàêÂäü',\n        user: {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n            phone: user.phone,\n            department: user.department,\n            avatar_seed: user.avatar_seed,\n            company: user.company,\n            is_admin: user.is_admin || false\n        }\n    }\n};\n\n// Ê≠£Â∏∏ÁôªÂΩï -> ËæìÂá∫1\nreturn [msg, null];\n\n\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 760,
        "y": 20,
        "wires": [
            [
                "e2ecf5e1fad297da"
            ],
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "e2ecf5e1fad297da",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "‰øùÂ≠òToken",
        "x": 970,
        "y": 20,
        "wires": [
            [
                "851b86051510e225"
            ]
        ]
    },
    {
        "id": "851b86051510e225",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÊûÑÂª∫ÁôªÂΩïÂìçÂ∫î",
        "func": "// Êó†ËÆ∫‰øùÂ≠òtokenÊàêÂäüÊàñÂ§±Ë¥•ÔºåÈÉΩËøîÂõûÁôªÂΩïÊàêÂäüÂìçÂ∫î\nmsg.payload = msg.userResponse;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1240,
        "y": 40,
        "wires": [
            [
                "bd6e9432646a2051",
                "25713032e80df106",
                "d0e0d2b04d5f2580"
            ]
        ]
    },
    {
        "id": "efc328b4427f30c1",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Âà∑Êñ∞TokenÊé•Âè£",
        "url": "/api/auth/refresh-token/",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 160,
        "y": 120,
        "wires": [
            [
                "eebdbea650d41b39"
            ]
        ]
    },
    {
        "id": "eebdbea650d41b39",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÂà∑Êñ∞TokenËØ∑Ê±Ç",
        "func": "// Ëé∑ÂèñÂà∑Êñ∞‰ª§Áâå\nconst refreshToken = msg.payload.refreshToken;\n\n// È™åËØÅÂèÇÊï∞\nif (!refreshToken) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_PARAMS\",\n            message: \"Âà∑Êñ∞‰ª§Áâå‰∏çËÉΩ‰∏∫Á©∫\"\n        }\n    };\n    return msg;\n}\n\n// È™åËØÅÂà∑Êñ∞‰ª§Áâå\nconst jwt = global.get('jwt');\nlet decoded;\ntry {\n    decoded = jwt.verify(refreshToken, process.env.JWT_REFRESH_SECRET);\n} catch (error) {\n    msg.statusCode = 401;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_REFRESH_TOKEN\",\n            message: \"Âà∑Êñ∞‰ª§ÁâåÊó†ÊïàÊàñÂ∑≤ËøáÊúü\"\n        }\n    };\n    return msg;\n}\n\n// Êü•ËØ¢‰ª§ÁâåÊòØÂê¶Â≠òÂú®‰∫éÊï∞ÊçÆÂ∫ì\nmsg.topic = \"SELECT * FROM tokens WHERE refresh_token = ? AND user_id = ?\";\nmsg.payload = [refreshToken, decoded.id];\nmsg.decoded = decoded; // ‰øùÂ≠òËß£Á†ÅÂêéÁöÑÊï∞ÊçÆ‰ª•‰æõÂêéÁª≠‰ΩøÁî®\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 370,
        "y": 120,
        "wires": [
            [
                "586e71e03b192e79"
            ]
        ]
    },
    {
        "id": "586e71e03b192e79",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Ê£ÄÊü•TokenÊòØÂê¶Â≠òÂú®",
        "x": 590,
        "y": 120,
        "wires": [
            [
                "9b9731b092868eba"
            ]
        ]
    },
    {
        "id": "9b9731b092868eba",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÁîüÊàêÊñ∞Token",
        "func": "const tokens = msg.payload;\nconst decoded = msg.decoded;\n\n// È™åËØÅ‰ª§ÁâåÊòØÂê¶Â≠òÂú®‰∫éÊï∞ÊçÆÂ∫ì\nif (tokens.length === 0) {\n    msg.statusCode = 401;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_REFRESH_TOKEN\",\n            message: \"Âà∑Êñ∞‰ª§ÁâåÂ∑≤Â§±ÊïàÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï\"\n        }\n    };\n    return msg;\n}\n\n// Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ\nmsg.topic = \"SELECT id, username, email, role, company FROM users1 WHERE id = ?\";\nmsg.payload = [decoded.id];\nmsg.oldToken = tokens[0]; // ‰øùÂ≠òÊóß‰ª§Áâå‰ø°ÊÅØ‰ª•‰æõÂêéÁª≠‰ΩøÁî®\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 770,
        "y": 120,
        "wires": [
            [
                "ee014dc649af6e4b"
            ]
        ]
    },
    {
        "id": "ee014dc649af6e4b",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØ",
        "x": 940,
        "y": 120,
        "wires": [
            [
                "0cb3db378b2953e8"
            ]
        ]
    },
    {
        "id": "0cb3db378b2953e8",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÂàõÂª∫Êñ∞Token",
        "func": "const users = msg.payload;\n\n// Áî®Êà∑‰∏çÂ≠òÂú®\nif (users.length === 0) {\n    msg.statusCode = 401;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"USER_NOT_FOUND\",\n            message: \"Áî®Êà∑‰∏çÂ≠òÂú®ÔºåËØ∑ÈáçÊñ∞ÁôªÂΩï\"\n        }\n    };\n    return msg;\n}\n\nconst user = users[0];\nconst oldToken = msg.oldToken;\n\n// ÁîüÊàêÊñ∞‰ª§Áâå\nconst jwt = global.get('jwt');\nconst uuid = global.get('uuid');\n\nconst tokenId = uuid.v4();\nconst refreshTokenId = uuid.v4();\n\n// ËÆæÁΩÆtokenËøáÊúüÊó∂Èó¥\nconst tokenExpiry = new Date();\ntokenExpiry.setHours(tokenExpiry.getHours() + 24); // 24Â∞èÊó∂ÊúâÊïà\n\n// ÂàõÂª∫token payload\nconst tokenPayload = {\n    id: user.id,\n    username: user.username,\n    role: user.role || 'user',\n    company: user.company,\n    jti: tokenId\n};\n\n// ÂàõÂª∫refresh token payload\nconst refreshPayload = {\n    id: user.id,\n    jti: refreshTokenId\n};\n\n// Á≠æÂèëtoken\nconst token = jwt.sign(tokenPayload, process.env.JWT_SECRET, { expiresIn: '24h' });\nconst refreshToken = jwt.sign(refreshPayload, process.env.JWT_REFRESH_SECRET, { expiresIn: '7d' });\n\n// ÂáÜÂ§áÊõ¥Êñ∞tokenÁöÑSQLËØ≠Âè•\nmsg.topic = \"UPDATE tokens SET token = ?, refresh_token = ?, expires_at = ? WHERE id = ?\";\nmsg.payload = [token, refreshToken, tokenExpiry, oldToken.id];\n\n// ‰øùÂ≠òtoken‰ø°ÊÅØÔºåÁî®‰∫éÂìçÂ∫î\nmsg.tokenResponse = {\n    success: true,\n    data: {\n        token: token,\n        refreshToken: refreshToken\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1130,
        "y": 120,
        "wires": [
            [
                "84d6a2b151cb994c"
            ]
        ]
    },
    {
        "id": "84d6a2b151cb994c",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Êõ¥Êñ∞Token",
        "x": 810,
        "y": 180,
        "wires": [
            [
                "04ea003bab93a361"
            ]
        ]
    },
    {
        "id": "04ea003bab93a361",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Âà∑Êñ∞TokenÂìçÂ∫î",
        "func": "// Êó†ËÆ∫Êõ¥Êñ∞tokenÊàêÂäüÊàñÂ§±Ë¥•ÔºåÈÉΩËøîÂõûÊñ∞token\nmsg.payload = msg.tokenResponse;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1040,
        "y": 180,
        "wires": [
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "6a9db7a3d4d7686c",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Ê£ÄÊü•ÁÆ°ÁêÜÂëòÁä∂ÊÄÅÊé•Âè£",
        "url": "/api/auth/check-admin/",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 170,
        "y": 260,
        "wires": [
            [
                "ee824beed3b65034"
            ]
        ]
    },
    {
        "id": "355a36260d4405ab",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Ëé∑ÂèñÁî®Êà∑ËßíËâ≤",
        "x": 600,
        "y": 260,
        "wires": [
            [
                "9fde5018df03c009"
            ]
        ]
    },
    {
        "id": "b9cbbdc381150e77",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "ÁôªÂá∫Êé•Âè£",
        "url": "/api/auth/logout/",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 320,
        "wires": [
            [
                "7dbccb064494de4e"
            ]
        ]
    },
    {
        "id": "7dbccb064494de4e",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÁôªÂá∫ËØ∑Ê±Ç",
        "func": "// ‰ªéËØ∑Ê±ÇÂ§¥Ëé∑Âèñ‰ª§Áâå\nconst authHeader = msg.req.headers.authorization;\nif (!authHeader || !authHeader.startsWith('Bearer ')) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_TOKEN\",\n            message: \"Êú™Êèê‰æõÊúâÊïàÁöÑ‰ª§Áâå\"\n        }\n    };\n    return msg;\n}\n\nconst token = authHeader.substring(7);\n\n// Â∞Ü‰ª§ÁâåÂä†ÂÖ•ÈªëÂêçÂçï\nmsg.topic = \"DELETE FROM tokens WHERE token = ?\";\nmsg.payload = [token];\n\n// ‰øùÂ≠òÂìçÂ∫îÁªìÊûú‰æõÂêéÁª≠‰ΩøÁî®\nmsg.logoutResponse = {\n    success: true,\n    message: \"Â∑≤ÊàêÂäüÁôªÂá∫\"\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 320,
        "wires": [
            [
                "d332cba5904f325f"
            ]
        ]
    },
    {
        "id": "d332cba5904f325f",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Â∞ÜTokenÂä†ÂÖ•ÈªëÂêçÂçï",
        "x": 610,
        "y": 320,
        "wires": [
            [
                "e8768dc722b54322"
            ]
        ]
    },
    {
        "id": "e8768dc722b54322",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÁôªÂá∫ÂìçÂ∫î",
        "func": "// Êó†ËÆ∫Â∞Ü‰ª§ÁâåÂä†ÂÖ•ÈªëÂêçÂçïÊòØÂê¶ÊàêÂäüÔºåÈÉΩËøîÂõûÁôªÂá∫ÊàêÂäüÂìçÂ∫î\nmsg.payload = msg.logoutResponse;\nreturn msg;",
        "outputs": 1,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 780,
        "y": 320,
        "wires": [
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "bd6e9432646a2051",
        "type": "http response",
        "z": "514ec94e7d382f6a",
        "name": "HTTPÂìçÂ∫î",
        "statusCode": "",
        "headers": {
            "Content-Type": "application/json",
            "Access-Control-Allow-Origin": "*"
        },
        "x": 1400,
        "y": 80,
        "wires": []
    },
    {
        "id": "324a8392b5a934a5",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÊ≥®ÂÜåËØ∑Ê±Ç",
        "func": "// Ëé∑ÂèñÊ≥®ÂÜå‰ø°ÊÅØ\nconst username = msg.payload.username;\nconst password = msg.payload.password;\nconst email = msg.payload.email;\nconst phone = msg.payload.phone || '';\nconst company = msg.payload.company || '';\nconst company_id = msg.payload.company_id || '';\nconst department = msg.payload.department || '';\nconst department_id = msg.payload.department_id || '';\nconst role = msg.payload.role || 'user';\n\n// È™åËØÅÂèÇÊï∞\nif (!username || !password || !email) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_PARAMS\",\n            message: \"Áî®Êà∑Âêç„ÄÅÂØÜÁ†ÅÂíåÈÇÆÁÆ±‰∏çËÉΩ‰∏∫Á©∫\"\n        }\n    };\n    return msg;\n}\n\n// È™åËØÅÈÇÆÁÆ±Ê†ºÂºè\nconst emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\nif (!emailRegex.test(email)) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_EMAIL\",\n            message: \"ÈÇÆÁÆ±Ê†ºÂºè‰∏çÊ≠£Á°Æ\"\n        }\n    };\n    return msg;\n}\n\n// ËÆæÁΩÆÊü•ËØ¢ÂèÇÊï∞ÔºåÊ£ÄÊü•Áî®Êà∑ÂêçÂíåÈÇÆÁÆ±ÊòØÂê¶Â∑≤Â≠òÂú®\nmsg.topic = \"SELECT * FROM users1 WHERE username = ? OR email = ?\";\nmsg.payload = [username, email];\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 400,
        "wires": [
            [
                "615ee1c83264aaa1"
            ]
        ]
    },
    {
        "id": "615ee1c83264aaa1",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â≠òÂú®",
        "x": 610,
        "y": 400,
        "wires": [
            [
                "cc1fe7f973854990"
            ]
        ]
    },
    {
        "id": "bce096ab91d12da3",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÂáÜÂ§áÂàõÂª∫Áî®Êà∑",
        "func": "const bcrypt = global.get('bcrypt');\nif (!bcrypt) {\n    throw new Error('bcrypt module not found');\n}\n\nconst uuid = global.get('uuid');\n\n// ÁîüÊàêÁî®Êà∑ID\nconst userId = uuid.v4();\n\n// ÂØπÂØÜÁ†ÅËøõË°åÂä†ÂØÜ\nconst salt = bcrypt.genSaltSync(10);\nif (!salt) {\n    throw new Error('Failed to generate salt');\n}\n\nconst hashedPassword = bcrypt.hashSync(msg.req.body.password, salt);\nif (!hashedPassword) {\n    throw new Error('Password hashing failed');\n}\n\n// ÊûÑÂª∫Áî®Êà∑ÂØπË±°\nconst newUser = {\n    id: userId,\n    username: msg.req.body.username,\n    password: hashedPassword,\n    email: msg.req.body.email,\n    phone: msg.req.body.phone || '',\n    company: msg.req.body.company || '',\n    department: msg.req.body.department || '',\n    status: 1\n};\n\n// ËÆæÁΩÆSQLÊèíÂÖ•ËØ≠Âè•\nmsg.topic = \"INSERT INTO users1 (uuid, username, password, email, phone, company,department,  status) VALUES (?,  ?,  ?, ?, ?, ?, ?, ?)\";\nmsg.payload = [\n    userId, \n    newUser.username, \n    newUser.password, \n    newUser.email, \n    newUser.phone, \n    newUser.company, \n    newUser.department, \n    newUser.status\n];\n\n// ‰øùÂ≠òÊñ∞Áî®Êà∑ÂØπË±°ÔºåÁî®‰∫éÂìçÂ∫î\nmsg.newUser = newUser;\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 980,
        "y": 400,
        "wires": [
            [
                "9ed4c64de1f442a9"
            ]
        ]
    },
    {
        "id": "9ed4c64de1f442a9",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "ÂàõÂª∫Áî®Êà∑",
        "x": 1140,
        "y": 400,
        "wires": [
            [
                "94b2c2ed156d3149"
            ]
        ]
    },
    {
        "id": "94b2c2ed156d3149",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Ê≥®ÂÜåÂìçÂ∫î",
        "func": "// ÂàõÂª∫Áî®Êà∑ÊàêÂäüÂêéÁöÑÂìçÂ∫î\n\n// ‰∏çËøîÂõûÂØÜÁ†ÅÁ≠âÊïèÊÑü‰ø°ÊÅØ\nconst userInfo = {\n    id: msg.newUser.id,\n    username: msg.newUser.username,\n    email: msg.newUser.email,\n    company: msg.newUser.company,\n    department: msg.newUser.department,\n    role: msg.newUser.role\n};\n\nmsg.payload = {\n    success: true,\n    data: userInfo\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 400,
        "wires": [
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "cc1fe7f973854990",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "function 65",
        "func": "// Â§ÑÁêÜÊü•ËØ¢ÁªìÊûúÔºåÊ£ÄÊü•ÊòØÂê¶Â∑≤ÊúâÁî®Êà∑\nif (msg.payload && msg.payload.length > 0) {\n    // Â¶ÇÊûúÊü•ËØ¢Âà∞Â∑≤ÊúâÁî®Êà∑ÔºåËøîÂõû400ÈîôËØØ\n    msg.statusCode = 400;\n    msg.payload = {\n        message: 'ËØ•ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜå'\n    };\n    return [msg,null];\n} else {\n    // Â¶ÇÊûúÊ≤°ÊúâÈáçÂ§çÁî®Êà∑ÔºåÂàôÁªßÁª≠Â§ÑÁêÜÂàõÂª∫Êñ∞Áî®Êà∑ÁöÑÈÄªËæë\n    return [null,msg];\n}\n",
        "outputs": 2,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 790,
        "y": 400,
        "wires": [
            [
                "bd6e9432646a2051"
            ],
            [
                "bce096ab91d12da3"
            ]
        ]
    },
    {
        "id": "419564095f3b5838",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "function 18",
        "func": "\nconst query = `\n    SELECT * FROM company;\n`;\nmsg.topic = query;\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 500,
        "wires": [
            [
                "c2e080ff30e25432"
            ]
        ]
    },
    {
        "id": "0b21bbd31fa67cf8",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Ëé∑ÂèñÂÖ¨Âè∏‰ø°ÊÅØ",
        "url": "api/companies",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 500,
        "wires": [
            [
                "419564095f3b5838"
            ]
        ]
    },
    {
        "id": "c2e080ff30e25432",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "",
        "x": 530,
        "y": 500,
        "wires": [
            [
                "update-user-response"
            ]
        ]
    },
    {
        "id": "2718baf06a75c02e",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Ëé∑ÂèñÁî®Êà∑ÂàóË°®",
        "url": "api/users",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 560,
        "wires": [
            [
                "7eb2adb19fc8700a"
            ]
        ]
    },
    {
        "id": "7eb2adb19fc8700a",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "function 19",
        "func": "\nconst query = `\n    SELECT * FROM users1;\n`;\nmsg.topic = query;\nreturn msg;\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 350,
        "y": 560,
        "wires": [
            [
                "5a2c0b8258e11c08"
            ]
        ]
    },
    {
        "id": "5a2c0b8258e11c08",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "",
        "x": 530,
        "y": 560,
        "wires": [
            [
                "update-user-response"
            ]
        ]
    },
    {
        "id": "update-user-response",
        "type": "http response",
        "z": "514ec94e7d382f6a",
        "name": "Send Updated User",
        "statusCode": "200",
        "headers": {
            "content-type": "application/json"
        },
        "x": 1320,
        "y": 620,
        "wires": []
    },
    {
        "id": "delete-user-endpoint",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Âà†Èô§Áî®Êà∑",
        "url": "/api/users/:id",
        "method": "delete",
        "upload": false,
        "swaggerDoc": "",
        "x": 140,
        "y": 700,
        "wires": [
            [
                "8caf43095817a5c0"
            ]
        ]
    },
    {
        "id": "delete-user-query",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Delete User",
        "x": 550,
        "y": 700,
        "wires": [
            [
                "check-delete-result"
            ]
        ]
    },
    {
        "id": "check-delete-result",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Check Delete Result",
        "func": "const result = msg.payload;\n\nif (result.affectedRows === 0) {\n    msg.statusCode = 404;\n    msg.payload = { error: 'Áî®Êà∑‰∏çÂ≠òÂú®' };\n    return [null, msg];\n}\n\nmsg.payload = { message: 'Âà†Èô§Áî®Êà∑ÊàêÂäü' };\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 700,
        "wires": [
            [
                "update-user-response"
            ],
            [
                "update-user-response"
            ]
        ]
    },
    {
        "id": "8caf43095817a5c0",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "function 4",
        "func": "const userId = msg.req.params.id; // Ëé∑ÂèñËØ∑Ê±Ç‰∏≠ÁöÑÁî®Êà∑ID\n\nif (!userId) {\n    msg.statusCode = 400;  // Â¶ÇÊûúÊú™‰º†ÂÖ• IDÔºåËøîÂõû 400\n    msg.payload = { error: 'Áº∫Â∞ëÁî®Êà∑ID' };\n    return [null, msg];\n}\n\n// Âà†Èô§Áî®Êà∑ËÆ∞ÂΩï\nmsg.topic = `DELETE FROM users1 WHERE id = ${userId}`;\n\nreturn [msg, null];\n\n\n",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 700,
        "wires": [
            [
                "delete-user-query"
            ]
        ]
    },
    {
        "id": "d4489cc0a3cb72c3",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Êõ¥Êñ∞Áî®Êà∑ËßíËâ≤",
        "url": "/api/users/:id/role",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 600,
        "wires": [
            [
                "3fb88bf70869f5a4"
            ]
        ]
    },
    {
        "id": "3fb88bf70869f5a4",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Prepare Update Query",
        "func": "const userId = msg.req.params.id;\nconst updates = msg.payload;\n\n// Èò≤Ê≠¢Êõ¥Êñ∞ÂØÜÁ†Å (ÈúÄË¶ÅÂçïÁã¨ÁöÑÊõ¥ÊîπÂØÜÁ†ÅÊé•Âè£)\ndelete updates.password;\n\n// Èò≤Ê≠¢Êõ¥Êñ∞created_atÂ≠óÊÆµ\ndelete updates.created_at;\n\n// Á°Æ‰øù updated_at Â≠óÊÆµÊòØÊúâÊïàÁöÑÊó•ÊúüÊó∂Èó¥Ê†ºÂºè\nif (updates.updated_at) {\n    const validDateTime = new Date(updates.updated_at).toISOString().slice(0, 19).replace('T', ' ');\n    updates.updated_at = validDateTime; // Êõ¥Êñ∞‰∏∫Ê≠£Á°ÆÁöÑÊ†ºÂºè\n}\n\n// ÊûÑÂª∫SETÂ≠êÂè•\nconst setClauses = [];\nconst params = [];\n\nfor (const [key, value] of Object.entries(updates)) {\n    if (value !== undefined && value !== null) {\n        setClauses.push(`${key} = ?`);\n        params.push(value);\n    }\n}\n\nif (setClauses.length === 0) {\n    msg.statusCode = 400;\n    msg.payload = { error: 'Ê≤°ÊúâÊèê‰æõË¶ÅÊõ¥Êñ∞ÁöÑÂ≠óÊÆµ' };\n    return [null, msg];\n}\n\n// Ê∑ªÂä†Áî®Êà∑ID‰Ωú‰∏∫WHEREÊù°‰ª∂ÁöÑÂèÇÊï∞\nparams.push(userId);\n\nmsg.payload = params;\nmsg.topic = `UPDATE users1 SET ${setClauses.join(', ')} WHERE id = ?`;\n\nreturn [msg, null];\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 620,
        "wires": [
            [
                "b0b7bbddca8ecce6"
            ]
        ]
    },
    {
        "id": "b0b7bbddca8ecce6",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Update User",
        "x": 550,
        "y": 620,
        "wires": [
            [
                "d6f48a18b4c26137"
            ]
        ]
    },
    {
        "id": "d6f48a18b4c26137",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Check Update Result",
        "func": "const result = msg.payload;  // Ëé∑ÂèñÂâç‰∏Ä‰∏™ËäÇÁÇπÁöÑÁªìÊûú\nconst userId = msg.req.params.id;  // Ëé∑Âèñ‰º†ÂÖ•ÁöÑÁî®Êà∑ID\n\n// Âà§Êñ≠Êï∞ÊçÆÂ∫ìÂÜôÂÖ•ÊòØÂê¶ÊàêÂäü\nif (result.affectedRows === 0) {\n    msg.statusCode = 404;  // ËÆæÁΩÆÁä∂ÊÄÅÁ†Å‰∏∫404ÔºåË°®Á§∫ÂÜôÂÖ•Â§±Ë¥•\n    msg.payload = { error: 'ÂÜôÂÖ•Â§±Ë¥•ÔºåÁî®Êà∑‰∏çÂ≠òÂú®' };  // ÈîôËØØ‰ø°ÊÅØ\n    return [null, msg];  // ËøîÂõûÈîôËØØÂìçÂ∫î\n}\n\n// ÂÜôÂÖ•ÊàêÂäüÂêéÔºåÊâßË°åÊü•ËØ¢Êìç‰Ωú\nmsg.topic = `SELECT * FROM users1 WHERE id = ?`;  // SQLÊü•ËØ¢ËØ≠Âè•Ôºå‰ΩøÁî®Âç†‰ΩçÁ¨¶\nmsg.payload = [userId]; // ‰Ωú‰∏∫ÂèÇÊï∞Êï∞ÁªÑ‰º†ÈÄíÔºàÊ≥®ÊÑèÈúÄË¶ÅÊòØÊï∞ÁªÑÊ†ºÂºèÔºâ\n\n// ËøîÂõûÊü•ËØ¢Êìç‰ΩúÁöÑÁªìÊûú\nreturn [msg, null];  // ËøîÂõûÂåÖÂê´Êü•ËØ¢Êìç‰ΩúÁöÑÊ∂àÊÅØ\n\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 740,
        "y": 620,
        "wires": [
            [
                "45934bfdab0feae0"
            ]
        ]
    },
    {
        "id": "45934bfdab0feae0",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Get Updated User",
        "x": 950,
        "y": 620,
        "wires": [
            [
                "update-user-response"
            ]
        ]
    },
    {
        "id": "25713032e80df106",
        "type": "debug",
        "z": "514ec94e7d382f6a",
        "name": "debug 30",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1220,
        "y": 280,
        "wires": []
    },
    {
        "id": "625e5d5293364150",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Êõ¥Êñ∞Áî®Êà∑ËßíËâ≤",
        "url": "/api/users/:id",
        "method": "put",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 640,
        "wires": [
            [
                "3fb88bf70869f5a4"
            ]
        ]
    },
    {
        "id": "0d04136b6093fc90",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "",
        "url": "/api/users/roles",
        "method": "get",
        "upload": false,
        "swaggerDoc": "",
        "x": 150,
        "y": 820,
        "wires": [
            [
                "62951dbbeed2dea9"
            ]
        ]
    },
    {
        "id": "62951dbbeed2dea9",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ËßíËâ≤Ê£ÄÊü•",
        "func": "const userId = msg.req.query.userId;\n\n\n// Êü•ËØ¢Áî®Êà∑ËßíËâ≤\nmsg.topic = \"SELECT is_admin FROM users1 WHERE id = ?\";\nmsg.payload = [userId]; // üëà ‰º†ÂÖ•Êï∞ÁªÑÂΩ¢ÂºèÁî®‰∫éÊõøÊç¢Âç†‰ΩçÁ¨¶\n\nreturn msg;\n",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 360,
        "y": 820,
        "wires": [
            [
                "b7b5895aa5356e42"
            ]
        ]
    },
    {
        "id": "b7b5895aa5356e42",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "",
        "x": 530,
        "y": 820,
        "wires": [
            [
                "50be8f665c2a1aa8"
            ]
        ]
    },
    {
        "id": "50be8f665c2a1aa8",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "function 93",
        "func": "const roleId = msg.payload[0].is_admin;\n\n\n// Êü•ËØ¢Áî®Êà∑ËßíËâ≤\nmsg.topic = \"SELECT name FROM roles WHERE id = ?\";\nmsg.payload = [roleId]; // üëà ‰º†ÂÖ•Êï∞ÁªÑÂΩ¢ÂºèÁî®‰∫éÊõøÊç¢Âç†‰ΩçÁ¨¶\n\nreturn msg;",
        "outputs": 1,
        "timeout": 0,
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 710,
        "y": 820,
        "wires": [
            [
                "bdc3304808cfdba3"
            ]
        ]
    },
    {
        "id": "bdc3304808cfdba3",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "",
        "x": 870,
        "y": 820,
        "wires": [
            [
                "f5404d9885f45d9a"
            ]
        ]
    },
    {
        "id": "f5404d9885f45d9a",
        "type": "http response",
        "z": "514ec94e7d382f6a",
        "name": "",
        "statusCode": "",
        "headers": {},
        "x": 1070,
        "y": 800,
        "wires": []
    },
    {
        "id": "process_register",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÁî®Êà∑Ê≥®ÂÜå",
        "func": "const { username, email, password, phone, department, company } = msg.payload;\n\n// Ê£ÄÊü•ÂøÖÂ°´Â≠óÊÆµ\nif (!username || !email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'Áî®Êà∑Âêç„ÄÅÈÇÆÁÆ±ÂíåÂØÜÁ†Å‰∏∫ÂøÖÂ°´È°π' };\n    return [null, msg];\n}\n\n// ÂÖàÊ£ÄÊü•ÈÇÆÁÆ±ÊòØÂê¶Â∑≤Â≠òÂú®\nmsg.topic = 'SELECT * FROM users.users1 WHERE email = ?';\nmsg.payload = [email];\nmsg.registerData = { username, email, password, phone, department, company };\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 1000,
        "wires": [
            [
                "check_existing_user"
            ],
            [
                "register_error"
            ]
        ]
    },
    {
        "id": "check_existing_user",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Ê£ÄÊü•Áî®Êà∑ÊòØÂê¶Â≠òÂú®",
        "x": 610,
        "y": 960,
        "wires": [
            [
                "validate_user_registration"
            ]
        ]
    },
    {
        "id": "validate_user_registration",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "È™åËØÅÁî®Êà∑Ê≥®ÂÜå",
        "func": "if (msg.payload.length > 0) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'ËØ•ÈÇÆÁÆ±Â∑≤Ë¢´Ê≥®ÂÜå' };\n    return [null, msg];\n}\n\n// ÁîüÊàêÂØÜÁ†ÅÂìàÂ∏åÂíåÂ§¥ÂÉèÁßçÂ≠ê\nconst bcrypt = global.get('bcrypt') || require('bcrypt');\nconst hashedPassword = bcrypt.hashSync(msg.registerData.password, 10);\nconst avatarSeed = Math.random().toString(36).substring(2, 15);\n\n// ÊèíÂÖ•Êñ∞Áî®Êà∑\nmsg.topic = 'INSERT INTO users.users1 (username, email, password, phone, department, company, avatar_seed, status) VALUES (?, ?, ?, ?, ?, ?, ?, 1)';\nmsg.payload = [\n    msg.registerData.username,\n    msg.registerData.email,\n    hashedPassword,\n    msg.registerData.phone,\n    msg.registerData.department,\n    msg.registerData.company,\n    avatarSeed\n];\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 860,
        "y": 960,
        "wires": [
            [
                "insert_new_user"
            ],
            [
                "register_error"
            ]
        ]
    },
    {
        "id": "insert_new_user",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "ÊèíÂÖ•Êñ∞Áî®Êà∑",
        "x": 1090,
        "y": 960,
        "wires": [
            [
                "register_success"
            ]
        ]
    },
    {
        "id": "register_success",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Ê≥®ÂÜåÊàêÂäü",
        "func": "msg.statusCode = 201;\nmsg.payload = { message: 'Ê≥®ÂÜåÊàêÂäü' };\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1280,
        "y": 960,
        "wires": [
            [
                "register_response"
            ]
        ]
    },
    {
        "id": "register_error",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Ê≥®ÂÜåÈîôËØØ",
        "func": "if (!msg.statusCode) {\n    msg.statusCode = 500;\n    msg.payload = { message: 'ÊúçÂä°Âô®ÈîôËØØ' };\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 1100,
        "y": 1020,
        "wires": [
            [
                "register_response"
            ]
        ]
    },
    {
        "id": "register_response",
        "type": "http response",
        "z": "514ec94e7d382f6a",
        "name": "Ê≥®ÂÜåÂìçÂ∫î",
        "statusCode": "",
        "headers": {
            "Content-Type": "application/json"
        },
        "x": 1380,
        "y": 1040,
        "wires": []
    },
    {
        "id": "process_login",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÁî®Êà∑ÁôªÂΩï",
        "func": "const { email, password } = msg.payload;\n\nif (!email || !password) {\n    msg.statusCode = 400;\n    msg.payload = { message: 'ÈÇÆÁÆ±ÂíåÂØÜÁ†Å‰∏∫ÂøÖÂ°´È°π' };\n    return [null, msg];\n}\n\nmsg.topic = 'SELECT * FROM users.users1 WHERE email = ? AND status = 1';\nmsg.payload = [email];\nmsg.loginPassword = password;\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 1060,
        "wires": [
            [
                "find_user"
            ],
            [
                "login_error"
            ]
        ]
    },
    {
        "id": "find_user",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "Êü•ÊâæÁî®Êà∑",
        "x": 620,
        "y": 1060,
        "wires": [
            [
                "validate_login"
            ]
        ]
    },
    {
        "id": "validate_login",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "È™åËØÅÁôªÂΩï",
        "func": "if (msg.payload.length === 0) {\n    msg.statusCode = 401;\n    msg.payload = { message: 'ÈÇÆÁÆ±ÊàñÂØÜÁ†ÅÈîôËØØ' };\n    return [null, msg];\n}\n\nconst user = msg.payload[0];\nconst bcrypt = global.get('bcrypt') || require('bcrypt');\n\nif (!bcrypt.compareSync(msg.loginPassword, user.password)) {\n    msg.statusCode = 401;\n    msg.payload = { message: 'ÈÇÆÁÆ±ÊàñÂØÜÁ†ÅÈîôËØØ' };\n    return [null, msg];\n}\n\nmsg.statusCode = 200;\nmsg.payload = {\n    message: 'ÁôªÂΩïÊàêÂäü',\n    user: {\n        id: user.id,\n        username: user.username,\n        email: user.email,\n        phone: user.phone,\n        department: user.department,\n        avatar_seed: user.avatar_seed,\n        company: user.company\n    }\n};\n\nreturn [msg, null];",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 850,
        "y": 1060,
        "wires": [
            [
                "login_response"
            ],
            [
                "login_error"
            ]
        ]
    },
    {
        "id": "login_error",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÁôªÂΩïÈîôËØØ",
        "func": "if (!msg.statusCode) {\n    msg.statusCode = 500;\n    msg.payload = { message: 'ÊúçÂä°Âô®ÈîôËØØ' };\n}\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 820,
        "y": 1120,
        "wires": [
            [
                "login_response"
            ]
        ]
    },
    {
        "id": "login_response",
        "type": "http response",
        "z": "514ec94e7d382f6a",
        "name": "ÁôªÂΩïÂìçÂ∫î",
        "statusCode": "",
        "headers": {
            "Content-Type": "application/json"
        },
        "x": 1400,
        "y": 1100,
        "wires": []
    },
    {
        "id": "ee824beed3b65034",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "Â§ÑÁêÜÁÆ°ÁêÜÂëòÊ£ÄÊü•ËØ∑Ê±Ç",
        "func": "// Ëé∑ÂèñÁî®Êà∑ID\nconst userId = msg.payload.userId;\n\n// È™åËØÅÂèÇÊï∞\nif (!userId) {\n    msg.statusCode = 400;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"INVALID_PARAMS\",\n            message: \"Áî®Êà∑ID‰∏çËÉΩ‰∏∫Á©∫\"\n        }\n    };\n    return msg;\n}\n\n// Êü•ËØ¢Áî®Êà∑ÁÆ°ÁêÜÂëòÁä∂ÊÄÅ\nmsg.topic = \"SELECT is_admin FROM users1 WHERE id = ?\";\nmsg.payload = [userId];\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 380,
        "y": 260,
        "wires": [
            [
                "355a36260d4405ab"
            ]
        ]
    },
    {
        "id": "9fde5018df03c009",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "ÁÆ°ÁêÜÂëòÊ£ÄÊü•ÂìçÂ∫î",
        "func": "const users = msg.payload;\n\n// Áî®Êà∑‰∏çÂ≠òÂú®\nif (users.length === 0) {\n    msg.statusCode = 404;\n    msg.payload = {\n        success: false,\n        error: {\n            code: \"USER_NOT_FOUND\",\n            message: \"Áî®Êà∑‰∏çÂ≠òÂú®\"\n        }\n    };\n    return msg;\n}\n\nconst user = users[0];\n\n// Ê£ÄÊü•Áî®Êà∑ÁÆ°ÁêÜÂëòÁä∂ÊÄÅ\nconst adminValue = user.is_admin || 0;\nconst isAdmin = adminValue === 1 || adminValue === true;\n\nmsg.payload = {\n    success: true,\n    data: {\n        is_admin: adminValue,\n        isAdmin: isAdmin\n    }\n};\n\nreturn msg;",
        "outputs": 1,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 800,
        "y": 260,
        "wires": [
            [
                "bd6e9432646a2051"
            ]
        ]
    },
    {
        "id": "d0e0d2b04d5f2580",
        "type": "debug",
        "z": "514ec94e7d382f6a",
        "name": "debug 41",
        "active": true,
        "tosidebar": true,
        "console": false,
        "tostatus": false,
        "complete": "true",
        "targetType": "full",
        "statusVal": "",
        "statusType": "auto",
        "x": 1440,
        "y": 180,
        "wires": []
    },
    {
        "id": "8d46292d35ddbc49",
        "type": "function",
        "z": "514ec94e7d382f6a",
        "name": "È™åËØÅÂØÜÁ†Å",
        "func": "const users = msg.payload;  // payload ÊòØÁî®Êà∑Êï∞ÁªÑ\nconst password = msg.req.body.password; // Ëé∑ÂèñÂâçÁ´ØÊèê‰∫§ÁöÑÂØÜÁ†Å\n\n// ÂÖ®Â±Ä‰æùËµñ\nconst bcrypt = global.get('bcrypt');\nconst jwt = global.get('jwt');\nconst uuid = global.get('uuid');\nconst jwtSecret = global.get('jwtSecret');\nconst jwtRefreshSecret = global.get('jwtRefreshSecret');\n\n// Áî®Êà∑‰∏çÂ≠òÂú®\nif (!users || users.length === 0) {\n    return [null, {\n            \"error\": {\n                \"code\": \"ERROR_CODE\",\n                \"message\": \"Áî®Êà∑‰∏çÂ≠òÂú®'\",\n                \"success\": false,   \n            }\n    }];\n}\n\nconst user = users[0];\n\n// ÂØÜÁ†Å‰∏çÂåπÈÖç\nconst passwordMatch = bcrypt.compareSync(password, user.password);\nif (!passwordMatch) {\n    return [null, {\n            \"error\": {\n                \"code\": \"ERROR_CODE\",\n                \"message\": \"Áî®Êà∑ÂêçÊàñÂØÜÁ†ÅÈîôËØØ\",\n                \"success\": false,\n            }\n    }];\n}\n\n// ÁôªÂΩïÊàêÂäüÔºöÁîüÊàê JWT Âíå Refresh Token\nconst tokenId = uuid.v4();\nconst refreshTokenId = uuid.v4();\n\nconst tokenExpiry = new Date();\ntokenExpiry.setHours(tokenExpiry.getHours() + 24); // 24Â∞èÊó∂ÊúâÊïà\n\nconst tokenPayload = {\n    id: user.id,\n    username: user.username,\n    role: user.role || 'user',\n    company: user.company,\n    jti: tokenId\n};\n\nconst refreshPayload = {\n    id: user.id,\n    jti: refreshTokenId\n};\n\nconst token = jwt.sign(tokenPayload, jwtSecret, { expiresIn: '24h' });\nconst refreshToken = jwt.sign(refreshPayload, jwtRefreshSecret, { expiresIn: '7d' });\n\nmsg.tokenInfo = {\n    id: tokenId,\n    user_id: user.id,\n    token: token,\n    refresh_token: refreshToken,\n    expires_at: tokenExpiry\n};\n\nmsg.topic = \"INSERT INTO tokens (id, user_id, token, refresh_token, expires_at) VALUES (?, ?, ?, ?, ?)\";\nmsg.payload = [tokenId, user.id, token, refreshToken, tokenExpiry];\n\nmsg.userResponse = {\n    success: true,\n    data: {\n        token: token,\n        refreshToken: refreshToken,\n        message: 'ÁôªÂΩïÊàêÂäü',\n        user: {\n            id: user.id,\n            username: user.username,\n            email: user.email,\n            phone: user.phone,\n            department: user.department,\n            avatar_seed: user.avatar_seed,\n            company: user.company,\n            is_admin: user.is_admin || false\n        }\n    }\n};\n\n// Ê≠£Â∏∏ÁôªÂΩï -> ËæìÂá∫1\nreturn [msg, null];\n\n\n",
        "outputs": 2,
        "timeout": "",
        "noerr": 0,
        "initialize": "",
        "finalize": "",
        "libs": [],
        "x": 940,
        "y": 1180,
        "wires": [
            [
                "23bff53cd1019cf5"
            ],
            []
        ]
    },
    {
        "id": "23bff53cd1019cf5",
        "type": "mysql",
        "z": "514ec94e7d382f6a",
        "mydb": "806ba83c98eb2e99",
        "name": "‰øùÂ≠òToken",
        "x": 1150,
        "y": 1180,
        "wires": [
            []
        ]
    },
    {
        "id": "91b8b91cf3c425b5",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "ÁôªÂΩïÊé•Âè£",
        "url": "/api/auth/login/",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 80,
        "wires": [
            [
                "2b3e427d203d6fee",
                "d0e0d2b04d5f2580"
            ]
        ]
    },
    {
        "id": "8c4f600ddf823760",
        "type": "http in",
        "z": "514ec94e7d382f6a",
        "name": "Ê≥®ÂÜåÊé•Âè£",
        "url": "/api/auth/register/",
        "method": "post",
        "upload": false,
        "swaggerDoc": "",
        "x": 120,
        "y": 20,
        "wires": [
            [
                "324a8392b5a934a5"
            ]
        ]
    },
    {
        "id": "806ba83c98eb2e99",
        "type": "MySQLdatabase",
        "name": "",
        "host": "192.168.1.108",
        "port": "13307",
        "db": "users",
        "tz": "",
        "charset": "UTF8"
    }
]